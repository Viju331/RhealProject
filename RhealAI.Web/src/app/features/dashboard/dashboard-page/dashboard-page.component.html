<div class="dashboard-page" *ngIf="!isLoading; else loading">
    <div class="container">
        <!-- Page Header -->
        <div class="page-header-section">
            <div>
                <h1 class="page-header">Analysis Dashboard</h1>
                <p class="page-subtitle">{{ repository?.name }}</p>
            </div>
            <div class="header-actions">
                <button mat-raised-button color="primary" [routerLink]="['/standards', repository?.id]">
                    <mat-icon>rule</mat-icon>
                    View Standards
                </button>
                <button mat-raised-button (click)="exportReport('json')">
                    <mat-icon>download</mat-icon>
                    Export Report
                </button>
            </div>
        </div>

        <!-- Project Summary Card -->
        <div class="glass-card project-summary-card" *ngIf="report?.projectSummary">
            <div class="project-summary-header">
                <mat-icon class="summary-icon">auto_awesome</mat-icon>
                <h2 class="summary-title">AI-Generated Project Summary</h2>
            </div>

            <div class="project-summary-content">
                <div class="summary-section">
                    <h3 class="summary-section-title">
                        <mat-icon>description</mat-icon>
                        Description
                    </h3>
                    <p class="summary-text">{{ report?.projectSummary?.description }}</p>
                </div>

                <div class="summary-grid">
                    <div class="summary-item">
                        <mat-icon class="item-icon">layers</mat-icon>
                        <div class="item-content">
                            <span class="item-label">Architecture</span>
                            <span class="item-value">{{ report?.projectSummary?.architecture }}</span>
                        </div>
                    </div>

                    <div class="summary-item">
                        <mat-icon class="item-icon">code</mat-icon>
                        <div class="item-content">
                            <span class="item-label">Technology Stack</span>
                            <span class="item-value">{{ report?.projectSummary?.technologyStack }}</span>
                        </div>
                    </div>

                    <div class="summary-item">
                        <mat-icon class="item-icon">language</mat-icon>
                        <div class="item-content">
                            <span class="item-label">Primary Language</span>
                            <span class="item-value">{{ report?.projectSummary?.primaryLanguage }}</span>
                        </div>
                    </div>

                    <div class="summary-item">
                        <mat-icon class="item-icon">business_center</mat-icon>
                        <div class="item-content">
                            <span class="item-label">Business Logic</span>
                            <span class="item-value">{{ report?.projectSummary?.businessLogic }}</span>
                        </div>
                    </div>
                </div>

                <div class="summary-section" *ngIf="(report?.projectSummary?.keyFeatures?.length || 0) > 0">
                    <h3 class="summary-section-title">
                        <mat-icon>star</mat-icon>
                        Key Features
                    </h3>
                    <div class="features-chips">
                        <span class="feature-chip" *ngFor="let feature of report?.projectSummary?.keyFeatures">
                            <mat-icon>check_circle</mat-icon>
                            {{ feature }}
                        </span>
                    </div>
                </div>

                <div class="summary-section" *ngIf="(report?.projectSummary?.mainComponents?.length || 0) > 0">
                    <h3 class="summary-section-title">
                        <mat-icon>widgets</mat-icon>
                        Main Components
                    </h3>
                    <div class="components-list">
                        <span class="component-tag" *ngFor="let component of report?.projectSummary?.mainComponents">
                            {{ component }}
                        </span>
                    </div>
                </div>

                <div class="summary-section" *ngIf="(report?.projectSummary?.dependencies?.length || 0) > 0">
                    <h3 class="summary-section-title">
                        <mat-icon>extension</mat-icon>
                        Dependencies
                    </h3>
                    <div class="dependencies-list">
                        <span class="dependency-chip" *ngFor="let dep of report?.projectSummary?.dependencies">
                            {{ dep }}
                        </span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Stats Overview -->
        <div class="stats-grid">
            <app-stat-card title="Total Files Analyzed" [value]="report?.totalFiles || 0" icon="folder"
                color="info"></app-stat-card>

            <app-stat-card title="Files with Violations" [value]="report?.filesWithViolations || 0" icon="description"
                color="warning"></app-stat-card>

            <app-stat-card title="Files with Bugs" [value]="report?.filesWithBugs || 0" icon="description"
                color="danger"></app-stat-card>

            <app-stat-card title="Total Violations" [value]="report?.totalViolations || 0" icon="warning"
                color="warning"></app-stat-card>

            <app-stat-card title="Total Bugs" [value]="report?.totalBugs || 0" icon="bug_report"
                color="danger"></app-stat-card>

            <app-stat-card title="Analysis Time" [value]="report?.executionTime || '0s'" icon="schedule"
                color="success"></app-stat-card>
        </div>

        <!-- Severity Distribution -->
        <div class="content-grid">
            <!-- Violations by Severity -->
            <div class="glass-card severity-card">
                <h3 class="card-title">
                    <mat-icon>warning</mat-icon>
                    Violations by Severity
                </h3>
                <div class="severity-list">
                    <div class="severity-item">
                        <app-severity-badge [severity]="SeverityLevel.Critical"
                            [count]="getSeverityCount(SeverityLevel.Critical, 'violations')"></app-severity-badge>
                        <div class="severity-bar">
                            <div class="bar-fill critical"
                                [style.width.%]="(getSeverityCount(SeverityLevel.Critical, 'violations') / (report?.totalViolations || 1)) * 100">
                            </div>
                        </div>
                    </div>
                    <div class="severity-item">
                        <app-severity-badge [severity]="SeverityLevel.High"
                            [count]="getSeverityCount(SeverityLevel.High, 'violations')"></app-severity-badge>
                        <div class="severity-bar">
                            <div class="bar-fill high"
                                [style.width.%]="(getSeverityCount(SeverityLevel.High, 'violations') / (report?.totalViolations || 1)) * 100">
                            </div>
                        </div>
                    </div>
                    <div class="severity-item">
                        <app-severity-badge [severity]="SeverityLevel.Medium"
                            [count]="getSeverityCount(SeverityLevel.Medium, 'violations')"></app-severity-badge>
                        <div class="severity-bar">
                            <div class="bar-fill medium"
                                [style.width.%]="(getSeverityCount(SeverityLevel.Medium, 'violations') / (report?.totalViolations || 1)) * 100">
                            </div>
                        </div>
                    </div>
                    <div class="severity-item">
                        <app-severity-badge [severity]="SeverityLevel.Low"
                            [count]="getSeverityCount(SeverityLevel.Low, 'violations')"></app-severity-badge>
                        <div class="severity-bar">
                            <div class="bar-fill low"
                                [style.width.%]="(getSeverityCount(SeverityLevel.Low, 'violations') / (report?.totalViolations || 1)) * 100">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Bugs by Severity -->
            <div class="glass-card severity-card">
                <h3 class="card-title">
                    <mat-icon>bug_report</mat-icon>
                    Bugs by Severity
                </h3>
                <div class="severity-list">
                    <div class="severity-item">
                        <app-severity-badge [severity]="SeverityLevel.Critical"
                            [count]="getSeverityCount(SeverityLevel.Critical, 'bugs')"></app-severity-badge>
                        <div class="severity-bar">
                            <div class="bar-fill critical"
                                [style.width.%]="(getSeverityCount(SeverityLevel.Critical, 'bugs') / (report?.totalBugs || 1)) * 100">
                            </div>
                        </div>
                    </div>
                    <div class="severity-item">
                        <app-severity-badge [severity]="SeverityLevel.High"
                            [count]="getSeverityCount(SeverityLevel.High, 'bugs')"></app-severity-badge>
                        <div class="severity-bar">
                            <div class="bar-fill high"
                                [style.width.%]="(getSeverityCount(SeverityLevel.High, 'bugs') / (report?.totalBugs || 1)) * 100">
                            </div>
                        </div>
                    </div>
                    <div class="severity-item">
                        <app-severity-badge [severity]="SeverityLevel.Medium"
                            [count]="getSeverityCount(SeverityLevel.Medium, 'bugs')"></app-severity-badge>
                        <div class="severity-bar">
                            <div class="bar-fill medium"
                                [style.width.%]="(getSeverityCount(SeverityLevel.Medium, 'bugs') / (report?.totalBugs || 1)) * 100">
                            </div>
                        </div>
                    </div>
                    <div class="severity-item">
                        <app-severity-badge [severity]="SeverityLevel.Low"
                            [count]="getSeverityCount(SeverityLevel.Low, 'bugs')"></app-severity-badge>
                        <div class="severity-bar">
                            <div class="bar-fill low"
                                [style.width.%]="(getSeverityCount(SeverityLevel.Low, 'bugs') / (report?.totalBugs || 1)) * 100">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Detailed Tables -->
        <mat-tab-group class="details-tabs">
            <!-- Violations Tab -->
            <mat-tab label="Violations ({{ allViolations.length }})">
                <div class="tab-content">
                    <div class="table-container">
                        <table mat-table [dataSource]="allViolations" class="violations-table">
                            <ng-container matColumnDef="severity">
                                <th mat-header-cell *matHeaderCellDef>Severity</th>
                                <td mat-cell *matCellDef="let violation">
                                    <app-severity-badge [severity]="violation.severity"></app-severity-badge>
                                </td>
                            </ng-container>

                            <ng-container matColumnDef="file">
                                <th mat-header-cell *matHeaderCellDef>File</th>
                                <td mat-cell *matCellDef="let violation">{{ violation.fileName || 'N/A' }}</td>
                            </ng-container>

                            <ng-container matColumnDef="line">
                                <th mat-header-cell *matHeaderCellDef>Line</th>
                                <td mat-cell *matCellDef="let violation">{{ violation.lineNumber }}</td>
                            </ng-container>

                            <ng-container matColumnDef="rule">
                                <th mat-header-cell *matHeaderCellDef>Rule</th>
                                <td mat-cell *matCellDef="let violation">{{ violation.ruleName }}</td>
                            </ng-container>

                            <ng-container matColumnDef="description">
                                <th mat-header-cell *matHeaderCellDef>Description</th>
                                <td mat-cell *matCellDef="let violation">{{ violation.description }}</td>
                            </ng-container>

                            <ng-container matColumnDef="actions">
                                <th mat-header-cell *matHeaderCellDef>Actions</th>
                                <td mat-cell *matCellDef="let violation">
                                    <button mat-icon-button color="primary">
                                        <mat-icon>visibility</mat-icon>
                                    </button>
                                </td>
                            </ng-container>

                            <tr mat-header-row *matHeaderRowDef="violationColumns"></tr>
                            <tr mat-row *matRowDef="let row; columns: violationColumns;"></tr>
                        </table>
                    </div>
                </div>
            </mat-tab>

            <!-- Bugs Tab -->
            <mat-tab label="Bugs ({{ allBugs.length }})">
                <div class="tab-content">
                    <div class="table-container">
                        <table mat-table [dataSource]="allBugs" class="bugs-table">
                            <ng-container matColumnDef="severity">
                                <th mat-header-cell *matHeaderCellDef>Severity</th>
                                <td mat-cell *matCellDef="let bug">
                                    <app-severity-badge [severity]="bug.severity"></app-severity-badge>
                                </td>
                            </ng-container>

                            <ng-container matColumnDef="title">
                                <th mat-header-cell *matHeaderCellDef>Title</th>
                                <td mat-cell *matCellDef="let bug">{{ bug.title }}</td>
                            </ng-container>

                            <ng-container matColumnDef="file">
                                <th mat-header-cell *matHeaderCellDef>File</th>
                                <td mat-cell *matCellDef="let bug">{{ bug.fileName || 'N/A' }}</td>
                            </ng-container>

                            <ng-container matColumnDef="impact">
                                <th mat-header-cell *matHeaderCellDef>Impact</th>
                                <td mat-cell *matCellDef="let bug">{{ bug.impact }}</td>
                            </ng-container>

                            <ng-container matColumnDef="actions">
                                <th mat-header-cell *matHeaderCellDef>Actions</th>
                                <td mat-cell *matCellDef="let bug">
                                    <button mat-icon-button color="primary">
                                        <mat-icon>visibility</mat-icon>
                                    </button>
                                </td>
                            </ng-container>

                            <tr mat-header-row *matHeaderRowDef="bugColumns"></tr>
                            <tr mat-row *matRowDef="let row; columns: bugColumns;"></tr>
                        </table>
                    </div>
                </div>
            </mat-tab>
        </mat-tab-group>
    </div>
</div>

<ng-template #loading>
    <app-loading-spinner message="Loading dashboard..."></app-loading-spinner>
</ng-template>